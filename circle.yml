# Customize the test machine
machine:
  pre:
      - git config --global user.email "circleci@joyent.zone"
      - git config --global user.name "circlebot"
      - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
      - docker
  node:
    version: 7.7.3

dependencies:
  pre:
      # install docker-compose
      - sudo curl -L https://github.com/docker/compose/releases/download/1.8.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
      - sudo chmod +x /usr/local/bin/docker-compose
      # install and setup triton
      - yarn global add triton@4.15.0 || cat /home/ubuntu/.yarn-config/global/yarn-error.log
      - echo '{"url":"https://eu-ams-1.api.joyent.com","account":"'$SDC_ACCOUNT'","keyId":"c3:30:35:9b:85:48:73:44:31:cc:4b:2e:6a:00:16:e2","name":"eu-ams-1","curr":true}' | triton profile create -f -
      - triton env --docker eu-ams-1
      # setup tap report
      - mkdir -p ${CIRCLE_TEST_REPORTS}/tap-xunit/
  override:
      # add rethinkdb sources
      - source /etc/lsb-release && echo "deb http://download.rethinkdb.com/apt $DISTRIB_CODENAME main" | sudo tee /etc/apt/sources.list.d/rethinkdb.list
      - wget -qO- https://download.rethinkdb.com/apt/pubkey.gpg | sudo apt-key add -
      # install zmq and rdb
      - sudo apt-get update && sudo apt-get install libzmq3-dev rethinkdb
      # install node dependencies
      - yarn install
      - yarn run prepare

test:
  override:
      # lint
      -  yarn run lint
      # test
      -  yarn run test

deployment:
  development:
    branch: master
    commands:
      - ./bin/docker-login
      - ./bin/build
      - ./bin/deploy
#   production:
#     tag: /production-*/
#     commands:
#       - CIRCLE_BRANCH=staging ./bin/docker-login
#       - CIRCLE_BRANCH=staging ./bin/on-changes-publish-ui
#       - CIRCLE_BRANCH=staging make -j2 build
#       - CIRCLE_BRANCH=staging make -j2 push
#       - CIRCLE_BRANCH=staging ./bin/deploy
